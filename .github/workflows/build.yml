name: Kernel Compilation

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release Tag'
        required: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/share/swift
        sudo rm -rf /usr/local/.ghcup
        sudo docker image prune --all --force
        df -h

    - name: Checkout source
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: recursive

    - name: Set up 20GB swap
      run: |
        export SWAP_FILE=$(swapon --show=NAME | tail -n 1)
        sudo swapoff $SWAP_FILE || true
        sudo rm -f $SWAP_FILE || true
        sudo fallocate -l 20G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        sudo swapon --show
        free -h

    - name: Set up build environment
      run: |
        sudo apt update -y
        sudo apt install -y \
          build-essential \
          bc \
          bison \
          flex \
          libssl-dev \
          libncurses5-dev \
          libelf-dev \
          binutils \
          m4 \
          gcc \
          g++ \
          make \
          git \
          zip \
          unzip \
          curl \
          wget \
          python3 \
          rsync \
          device-tree-compiler \
          cpio \
          ccache

    - name: Configure system for compilation
      run: |
        sudo sysctl vm.swappiness=100
        sudo sysctl vm.vfs_cache_pressure=50
        ulimit -n 65536

    - name: Set environment variables
      run: |
        echo "BUILD_KERNEL_VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        echo "MAKEFLAGS=-j$(nproc)" >> $GITHUB_ENV
        echo "CCACHE_DIR=${{ github.workspace }}/.ccache" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=5G" >> $GITHUB_ENV

    - name: Cache ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-${{ github.ref }}
        restore-keys: |
          ccache-

    - name: Compile Kernel
      run: |
        START=$(date +%s)
        bash build.sh
        END=$(date +%s)
        echo "Build took $((END-START)) seconds"

    - name: Check build artifacts
      run: |
        ls -lh dist/ || echo "dist folder missing"
        du -sh dist/ || true

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SukiSU-Ultra-SUSFS-SM-A165F-${{ github.event.inputs.tag }}-${{ github.run_number }}
        path: dist/*
        retention-days: 30
        if-no-files-found: warn

    - name: Create release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.event.inputs.tag }}
        name: "SukiSU-Ultra-SUSFS-SM-A165F-${{ github.event.inputs.tag }}"
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: "dist/*"
        body: |
          ## SukiSU-Ultra Kernel Build

          **Release:** ${{ github.event.inputs.tag }}
          **Commit:** ${{ github.sha }}
          **Build:** ${{ github.run_number }}

          ### Installation
          1. Extract the tar file
          2. Flash boot.img:

             fastboot flash boot boot.img

          3. Or flash via TWRP/custom recovery
          4. Reboot and enjoy 
